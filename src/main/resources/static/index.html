<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="/reset.css" rel="stylesheet" />
  <link href="/global.css" rel="stylesheet" />
  <link href="/main.css" rel="stylesheet" />
</head>
<body>
<div class="container">
  <header class="header">
    <a href="/index.html"><img src="/img/signiture.svg" /></a>
    <ul class="header__menu">
      <li class="header__menu__item">
        <a class="btn btn_contained btn_size_s" href="/user/login.html">로그인</a>
      </li>
      <li class="header__menu__item">
        <a class="btn btn_ghost btn_size_s" href="/registration">회원 가입</a>
      </li>
    </ul>
  </header>

  <div class="wrapper">
    <div class="post">
      <div class="post__account">
        <img class="post__account__img" id="account-img" />
        <p class="post__account__nickname" id="nickname"></p>
      </div>
      <img class="post__img" id="post-img" />
      <div class="post__menu">
        <ul class="post__menu__personal">
          <li>
            <button class="post__menu__btn">
              <img src="./img/like.svg" />
            </button>
          </li>
          <li>
            <button class="post__menu__btn">
              <img src="./img/sendLink.svg" />
            </button>
          </li>
        </ul>
        <button class="post__menu__btn">
          <img src="./img/bookMark.svg" />
        </button>
      </div>
      <p class="post__article" id="post-article"></p>
    </div>

    <ul class="comment" id="comment-list"></ul>
    <button id="show-all-btn" class="btn btn_ghost btn_size_m" style="display:none">
      모든 댓글 보기
    </button>

    <nav class="nav">
      <ul class="nav__menu">
        <li class="nav__menu__item">
          <a class="nav__menu__item__btn" href="#" id="prev-btn">
            <img class="nav__menu__item__img" src="./img/ci_chevron-left.svg" />
            이전 글
          </a>
        </li>
        <li class="nav__menu__item">
          <a class="btn btn_ghost btn_size_m" id="comment-link">댓글 작성</a>
        </li>
        <li class="nav__menu__item">
          <a class="nav__menu__item__btn" href="#" id="next-btn">
            다음 글
            <img class="nav__menu__item__img" src="./img/ci_chevron-right.svg" />
          </a>
        </li>
      </ul>
    </nav>

    <div style="text-align: center; margin-top: 24px;">
      <a class="btn btn_contained btn_size_s" id="write-btn" href="#">글쓰기</a>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;

  async function loadArticleAndComments(page) {
    try {
      const articleRes = await fetch(`/api/articles?page=${page}`);
      const articleData = await articleRes.json();

      if (!articleData.isSuccess && articleData.code === "ARTICLE-01") {
        document.getElementById("post-article").textContent = articleData.message || "게시글이 없습니다.";
        document.getElementById("post-img").removeAttribute("src");
        document.getElementById("comment-list").innerHTML = "";
        document.getElementById("comment-link").href = "/comment";
        return false;
      }
      if (!articleData.isSuccess && articleData.code === "ARTICLE-02") {
        console.warn("게시글이 없거나 오류:", articleData.message);
        return false;
      }

      const data = articleData.data;
      const {
        articleId,
        writerName,
        writerBase64Image,
        content,
        base64Image,
        comments
      } = data;

      document.getElementById("nickname").textContent = writerName || "Unknown";

      const accountImg = document.getElementById("account-img");
      if (writerBase64Image) {
        accountImg.src = `data:image/png;base64,${writerBase64Image}`;
        accountImg.style.removeProperty("background-color");
        accountImg.style.width = "40px";
        accountImg.style.height = "40px";
        accountImg.style.borderRadius = "50%";
      } else {
        accountImg.removeAttribute("src");
        accountImg.style.backgroundColor = "#ccc";
        accountImg.style.width = "40px";
        accountImg.style.height = "40px";
        accountImg.style.borderRadius = "50%";
      }

      document.getElementById("post-article").textContent = content || "";
      const postImg = document.getElementById("post-img");
      if (base64Image) {
        postImg.src = `data:image/png;base64,${base64Image}`;
      } else {
        postImg.removeAttribute("src");
      }

      renderComments(comments);
      document.getElementById("comment-link").href = "/comment";

      return true;
    } catch (err) {
      console.error("게시글 로딩 중 오류:", err);
      document.getElementById("post-article").textContent = "오류 발생";
      return false;
    }
  }

  function renderComments(comments) {
    const commentList = document.getElementById("comment-list");
    const showAllBtn = document.getElementById("show-all-btn");
    showAllBtn.style.display = "none";
    commentList.innerHTML = "";

    if (!comments || comments.length === 0) {
      return;
    }

    comments.forEach((comment, idx) => {
      const nickname = comment.nickname || "Unknown";
      const base64Profile = comment.base64Profile;

      const li = document.createElement("li");
      li.className = "comment__item";
      if (idx >= 3) {
        li.classList.add("hidden");
      }

      let profileImgHtml = "";
      if (base64Profile) {
        profileImgHtml = `
          <img class="comment__item__user__img"
               style="border-radius:50%; width:24px; height:24px;"
               src="data:image/png;base64,${base64Profile}" />`;
      } else {
        profileImgHtml = `
          <img class="comment__item__user__img"
               style="width:24px; height:24px; border-radius:50%; background-color:#ccc;" />`;
      }

      li.innerHTML = `
        <div class="comment__item__user">
          ${profileImgHtml}
          <p class="comment__item__user__nickname">${nickname}</p>
        </div>
        <p class="comment__item__article">${comment.content}</p>
      `;
      commentList.appendChild(li);
    });

    if (comments.length > 3) {
      showAllBtn.style.display = "inline-block";
      showAllBtn.textContent = `모든 댓글 보기(${comments.length - 3}개)`;
      showAllBtn.onclick = () => {
        document.querySelectorAll("#comment-list .comment__item.hidden").forEach(e => {
          e.classList.remove("hidden");
        });
        showAllBtn.style.display = "none";
      };
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadArticleAndComments(currentPage).then(() => {
      document.getElementById("prev-btn").addEventListener("click", async (e) => {
        e.preventDefault();
        currentPage++;
        const ok = await loadArticleAndComments(currentPage);
        if (!ok) {
          currentPage--;
          alert("현재가 가장 마지막 글이에요!");
        }
      });

      document.getElementById("next-btn").addEventListener("click", async (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          const ok = await loadArticleAndComments(currentPage);
          if (!ok) {
            currentPage++;
            alert("현재가 가장 최신 글이에요!");
          }
        } else {
          alert("현재가 가장 최신 글이에요!");
        }
      });
    });
  });

  document.getElementById("write-btn").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (data.isSuccess) {
        window.location.href = "/write.html";
      } else {
        alert("로그인 후 이용할 수 있어요!");
        window.location.href = "/user/login.html";
      }
    } catch (error) {
      console.error("글쓰기 버튼 클릭 중 오류:", error);
      window.location.href = "/user/login.html";
    }
  });

  document.getElementById("comment-link").addEventListener("click", async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (!data.isSuccess) {
        alert("로그인 후 이용할 수 있어요!");
        window.location.href = "/user/login.html";
        return;
      }
    } catch (err) {
      console.error("로그인 여부 확인 중 오류:", err);
      alert("로그인 후 이용할 수 있어요!");
      window.location.href = "/user/login.html";
      return;
    }

    if (!latestArticleId) {
      alert("아직 작성된 글이 없습니다. 새로운 게시글을 작성해주세요!");
      window.location.href = "/write.html";
      return;
    }

    window.location.href = `/article/${latestArticleId}/comment`;
  });
</script>
</body>
</html>