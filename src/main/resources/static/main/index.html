<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="../reset.css" rel="stylesheet" />
  <link href="../global.css" rel="stylesheet" />
  <link href="../main.css" rel="stylesheet" />
  <title>메인 페이지</title>
</head>
<body>
<div class="container">
  <header class="header">
    <a href="/index.html"><img src="../img/signiture.svg" /></a>
    <ul class="header__menu">
      <li class="header__menu__item">
        <button
                id="greeting-btn"
                class="btn btn_ghost btn_size_s"
        >
          안녕하세요 <span id="greeting-nickname"></span>님
        </button>
      </li>
      <li class="header__menu__item">
        <button class="btn btn_contained btn_size_s" id="write-btn">
          글쓰기
        </button>
      </li>
      <li class="header__menu__item">
        <button id="logout-btn" class="btn btn_ghost btn_size_s">
          로그아웃
        </button>
      </li>
    </ul>
  </header>

  <div class="wrapper">
    <div class="post">
      <div class="post__account">
        <img class="post__account__img" id="account-img" alt="" />
        <span id="nickname"></span>
      </div>
      <img class="post__img"  id="post-img"/>
      <div class="post__menu">
        <ul class="post__menu__personal">
          <li>
            <button class="post__menu__btn">
              <img src="../img/like.svg" />
            </button>
          </li>
          <li>
            <button class="post__menu__btn">
              <img src="../img/sendLink.svg" />
            </button>
          </li>
        </ul>
        <button class="post__menu__btn">
          <img src="../img/bookMark.svg" />
        </button>
      </div>
      <p id="post-article" class="post__article"></p>
    </div>
    <ul class="comment">
      <li class="comment__item">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">
          군인 또는 군무원이 아닌 국민은 대한민국의 영역안에서는 중대한
          군사상 기밀·초병·초소·유독음식물공급·포로·군용물에 관한 죄중
          법률이 정한 경우와 비상계엄이 선포된 경우를 제외하고는 군사법원의
          재판을 받지 아니한다.
        </p>
      </li>
      <li class="comment__item">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">
          대통령의 임기연장 또는 중임변경을 위한 헌법개정은 그 헌법개정 제안
          당시의 대통령에 대하여는 효력이 없다. 민주평화통일자문회의의
          조직·직무범위 기타 필요한 사항은 법률로 정한다.
        </p>
      </li>
      <li class="comment__item">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">
          민주평화통일자문회의의 조직·직무범위 기타 필요한 사항은 법률로
          정한다.
        </p>
      </li>
      <li class="comment__item hidden">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">Comment 1</p>
      </li>
      <li class="comment__item hidden">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">Comment 2</p>
      </li>
      <li class="comment__item hidden">
        <div class="comment__item__user">
          <img class="comment__item__user__img" />
          <p class="comment__item__user__nickname">account</p>
        </div>
        <p class="comment__item__article">Comment 3</p>
      </li>
      <button id="show-all-btn" class="btn btn_ghost btn_size_m">
        모든 댓글 보기(3개)
      </button>
    </ul>
    <nav class="nav">
      <ul class="nav__menu">
        <li class="nav__menu__item">
          <a class="nav__menu__item__btn" href="">
            <img
                    class="nav__menu__item__img"
                    src="../img/ci_chevron-left.svg"
            />
            이전 글
          </a>
        </li>
        <li class="nav__menu__item">
          <a class="btn btn_ghost btn_size_m" href="/comment">댓글 작성</a>
        </li>
        <li class="nav__menu__item">
          <a class="nav__menu__item__btn" href="">
            다음 글
            <img
                    class="nav__menu__item__img"
                    src="../img/ci_chevron-right.svg"
            />
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const response = await fetch("/api/user/validate");
      const result = await response.json();

      if (result.isSuccess) {
        const { name, base64Image } = result.data;

        document.getElementById("nickname").textContent = name;
        document.getElementById("greeting-nickname").textContent = name;

        if (base64Image) {
          document.getElementById("account-img").src = `data:image/png;base64,${base64Image}`;
        } else {
          document.getElementById("account-img").removeAttribute("src");
          document.getElementById("account-img").style.backgroundColor = "#ccc";
          document.getElementById("account-img").style.width = "40px";
          document.getElementById("account-img").style.height = "40px";
          document.getElementById("account-img").style.borderRadius = "50%";
        }
      } else {
        console.warn("로그인이 필요합니다.");
      }
    } catch (error) {
      console.error("사용자 정보 요청 중 오류:", error);
    }

    try {
      const articleRes = await fetch("/api/article");
      const articleData = await articleRes.json();
      if (articleData.isSuccess) {
        const { content, base64Image } = articleData.data;
        document.getElementById("post-article").textContent =
                content;
        if (base64Image) {
          document.getElementById("post-img").src = `data:image/png;base64,${base64Image}`;
        } else {
          document.getElementById("post-img").removeAttribute("src");
        }
      } else {
        console.warn("게시글이 없거나 오류:", articleData.message);
        document.getElementById("post-article").textContent = "\"게시글이 없어요. 새로운 글을 작성해주세요!\"";
      }
    } catch (err) {
      console.error("게시글 로딩 중 오류:", err);
    }
  });

  document.getElementById("write-btn").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (data.isSuccess) {
        window.location.href = "/write.html";
      } else {
        alert("로그인이 필요한 서비스입니다.");
        window.location.href = "/user/login.html";
      }
    } catch (error) {
      console.error("글쓰기 버튼 클릭 중 오류:", error);
      window.location.href = "/user/login.html";
    }
  });

  document.getElementById("logout-btn").addEventListener("click", async () => {
    try {
      const response = await fetch("/api/logout", { method: "POST" });
      const result = await response.json();
      console.log("로그아웃 응답:", result);
    } catch (error) {
      console.error("로그아웃 요청 중 오류:", error);
    }
    alert("로그아웃이 완료 되었어요!")
    window.location.href = "/index.html";
  });

  document.getElementById("account-img").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (data.isSuccess) {
        window.location.href = "/mypage";
      } else {
        window.location.href = "/user/login.html";
      }
    } catch (error) {
      console.error("프로필 이동 중 오류:", error);
      window.location.href = "/user/login.html";
    }
  });

  document.getElementById("nickname").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (data.isSuccess) {
        window.location.href = "/mypage";
      } else {
        alert("세션이 만료 되었어요. 다시 로그인 해주세요.")
        window.location.href = "/user/login.html";
      }
    } catch (error) {
      console.error("프로필 이동 중 오류:", error);
      window.location.href = "/user/login.html";
    }
  });

  document.getElementById("greeting-btn").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/user/validate");
      const data = await res.json();
      if (data.isSuccess) {
        window.location.href = "/mypage";
      } else {
        alert("로그인이 필요한 서비스입니다.");
        window.location.href = "/user/login.html";
      }
    } catch (error) {
      console.error("greeting-btn 클릭 중 오류:", error);
      window.location.href = "/user/login.html";
    }
  });
</script>
</body>
</html>